---
/**
 * BlogTableOfContents component - Display table of contents for blog posts
 */
import type { TocItem } from "@/types/blog";

interface Props {
  items: TocItem[];
  title?: string;
  maxDepth?: number;
}

const { items, title = "Table of Contents", maxDepth = 3 } = Astro.props;

// Filter by max depth
const filteredItems = items.filter(item => item.depth <= maxDepth);

// Don't render if no items
if (filteredItems.length === 0) return;
---

<nav class="my-6 rounded-lg border border-foreground/10 bg-foreground/5 p-4">
  <h2 class="mb-3 text-lg font-semibold">{title}</h2>
  <ul class="space-y-2">
    {
      filteredItems.map(item => {
        // Use predefined classes for depth levels
        const depthClass = item.depth === 2 ? "ml-4" : item.depth === 3 ? "ml-8" : "";
        return (
          <li class={`${depthClass} text-sm`}>
            <a
              href={`#${item.slug}`}
              class="text-accent hover:underline decoration-dashed underline-offset-4"
            >
              {item.text}
            </a>
            {item.children && item.children.length > 0 && (
              <ul class="mt-1 space-y-1">
                {item.children.map(child => {
                  const childDepthClass = child.depth === 2 ? "ml-4" : child.depth === 3 ? "ml-6" : "ml-8";
                  return (
                    <li class={`${childDepthClass} text-sm`}>
                      <a
                        href={`#${child.slug}`}
                        class="text-foreground/70 hover:text-accent hover:underline decoration-dashed underline-offset-4"
                      >
                        {child.text}
                      </a>
                    </li>
                  );
                })}
              </ul>
            )}
          </li>
        );
      })
    }
  </ul>
</nav>

<script>
  // Highlight active section in TOC
  function updateActiveTocItem() {
    const tocLinks = document.querySelectorAll(
      'nav a[href^="#"]'
    ) as NodeListOf<HTMLAnchorElement>;
    const headings = Array.from(
      document.querySelectorAll("h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]")
    );

    let currentActive: Element | null = null;

    for (const heading of headings) {
      const rect = heading.getBoundingClientRect();
      if (rect.top <= 100) {
        currentActive = heading;
      }
    }

    tocLinks.forEach(link => {
      link.classList.remove("font-bold");
      if (currentActive && link.getAttribute("href") === `#${currentActive.id}`) {
        link.classList.add("font-bold");
      }
    });
  }

  // Update on scroll
  if (typeof window !== "undefined") {
    window.addEventListener("scroll", updateActiveTocItem, { passive: true });
    updateActiveTocItem();
  }
</script>
